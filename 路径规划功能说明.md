# 地震逃生路径规划功能说明

## 功能概述

应用已升级为使用高德地图Web API进行真实的步行路径规划，而不是简单的直线连接。这将为用户提供更准确、更实用的逃生路线指引。

## 功能特点

### 1. 智能路径规划
- **真实路径**: 使用高德地图Web API获取真实的步行路线，考虑道路状况
- **详细路径点**: 显示完整的路径轨迹，而不是简单的直线
- **转向指示**: 提供详细的转向指令和距离信息
- **时间预估**: 基于真实路径距离计算准确的步行时间

### 2. 多级回退机制
应用采用三级回退策略确保始终能提供导航功能：

1. **第一级**: 高德地图Web API路径规划（推荐）
2. **第二级**: 高德地图Android SDK路径规划
3. **第三级**: 简单直线路径计算（兜底方案）

### 3. 3D增强显示
- **详细路径**: 在3D模式下使用实线显示真实路径
- **简单路径**: 在2D/3D模式下使用虚线显示直线路径
- **视觉区分**: 真实路径和直线路径使用不同的线条样式

## 技术实现

### Web API路径规划服务
- **服务类**: `AMapWebRouteService`
- **API端点**: `https://restapi.amap.com/v3/direction/walking`
- **响应格式**: JSON
- **路径点格式**: Polyline坐标串

### 路径显示组件
- **组件**: `SafetyLocationMarkers`
- **路径绘制**: 使用高德地图SDK的Polyline功能
- **标记管理**: 自动清理和更新路径标记

## 使用方法

### 1. 配置API密钥
在 `app/src/main/res/values/strings.xml` 中配置您的高德地图Web API密钥：
```xml
<string name="amap_web_api_key">您的Web API密钥</string>
```

### 2. 启动导航
1. 在地震预警界面点击"逃生导航"
2. 选择目标安全地点
3. 点击"导航"按钮
4. 系统自动规划并显示最佳路径

### 3. 查看路径详情
- **路径显示**: 在地图上以蓝色线条显示路径
- **指令列表**: 在导航面板中查看详细的转向指令
- **距离时间**: 显示总距离和预计步行时间

## 路径类型识别

应用会自动识别和显示不同类型的路径：

### 真实规划路径
- **特征**: 路径点数量 > 2
- **显示**: 实线，较宽线条
- **颜色**: 蓝色主线 + 白色中心线（3D模式）
- **标记**: 绿色起点 + 蓝色终点

### 简单直线路径
- **特征**: 路径点数量 = 2
- **显示**: 虚线，标准线宽
- **颜色**: 蓝色虚线
- **标记**: 仅终点标记

## 调试信息

### 日志标签
- `AMapWebRouteService`: Web API调用和响应
- `SafetyLocationMarkers`: 路径显示和标记管理
- `SafetyLocationRepository`: 路径规划协调

### 关键日志
```
D/AMapWebRouteService: 开始步行路径规划
D/AMapWebRouteService: 请求URL: https://restapi.amap.com/v3/direction/walking?...
D/AMapWebRouteService: 收到响应，长度: xxx
D/AMapWebRouteService: 路径规划成功! 距离: xxx米, 路径点: xxx个
D/SafetyLocationMarkers: 添加导航路线成功，路径点数：xxx
```

## 故障排除

### 1. 路径显示为直线
**可能原因**:
- Web API密钥配置错误
- 网络连接问题
- API配额用完

**解决方案**:
1. 检查API密钥是否正确配置
2. 查看日志中的API响应信息
3. 确认网络连接正常

### 2. 无法获取路径
**可能原因**:
- 起点或终点位置不可达
- API服务异常

**解决方案**:
1. 应用会自动回退到直线路径
2. 检查日志获取详细错误信息

### 3. 路径不合理
**可能原因**:
- 地图数据更新滞后
- 特殊路况（施工、封路等）

**解决方案**:
1. 用户可手动调整路径
2. 参考路径指令进行必要绕行

## 性能优化

### 1. 缓存机制
- 相同起终点的路径会被缓存
- 避免重复的API调用

### 2. 异步处理
- 路径规划在后台线程执行
- 不阻塞UI操作

### 3. 超时控制
- HTTP请求设置10秒连接超时
- 15秒读取超时，确保响应及时

## 未来扩展

### 1. 路况感知
- 集成实时路况信息
- 避开拥堵和危险区域

### 2. 多路径选择
- 提供多条备选路径
- 用户可选择最适合的路线

### 3. 语音导航
- 添加语音播报功能
- 支持震动提醒

### 4. 离线路径
- 预下载区域地图数据
- 支持离线路径规划

---

**注意**: 请确保在正式部署前测试路径规划功能，验证API密钥配置正确，并在不同网络环境下测试功能稳定性。 